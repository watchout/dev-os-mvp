...
# DEV_RULES.md

AI開発OS / dev-os-mvp 開発ルール v0.1

## 0. このドキュメントの目的

このリポジトリは「破綻しない AI 開発OS（dev-os）」のMVP実装を行うためのものです。  

ここに書かれているルールは、

- このリポジトリでの開発ルール
- 将来、この開発OSをSaaSとして提供する際に「各プロジェクトに自動配布される開発ルール」の原型

として機能します。

**重要:**  
仕様・設計・プロンプト・タスク管理は、必ず「SSOT（Single Source of Truth）」を通して行い、  
単一LLMへの丸投げを禁止し、複数LLMの相互チェックを基本とします。

---

## 1. ロールと責任

### 1.1 人間のロール

- **オーナー / プロダクト責任者**
  - 最終的な仕様・優先順位・スコープを決定する。
  - AIが提案した仕様・設計案に対して「採用 / 却下 / 修正指示」を行う。

- **開発者（人間）**
  - AIの出したコード・設定・仕様をレビューし、必要なら修正する。
  - 重要な設計判断は `DEV_OS_SPEC.md` と SSOT 群に反映する。

### 1.2 AIロール

- **設計・管理AI（Architect / Manager AI）**
  - `DEV_OS_SPEC.md` と SSOT を正本として読み、情報を更新する。
  - ファイル構成・ワークフロー・LLM構成の提案と編集を担当。
  - 大きな設計変更は必ず人間と確認してから確定する。

- **実装AI（Implementation AI）**
  - 仕様と SSOT に基づき、コード・設定ファイル・スクリプトを実装する。
  - 変更範囲を明示し、必要な部分のみ編集する。
  - 設計判断は行わず、迷う場合は設計AIまたは人間にエスカレーションする。

- **監査AI（Audit / Review AI）※今後導入**
  - SSOTと実装コードの整合性チェック
  - セキュリティ・パフォーマンス・保守性の観点からのレビュー

---

## 2. SSOT（Single Source of Truth）の原則

1. **仕様の正本**
   - プロダクト全体の設計思想・方針・フェーズ定義は `DEV_OS_SPEC.md` に集約する。
   - 機能別の仕様・用語・ルールは `ssot/*.yml` に構造化して記述する。

2. **「SSOTを通さない設計変更」を禁止**
   - 画面・API・データ構造などに影響する変更は、
     - 先に SSOT を更新
     - その後、実装AIにコード変更を依頼
   - コードだけを先に変えて、あとから仕様を書き足す、という順序は禁止。

3. **ファイルの役割分担**
   - `DEV_OS_SPEC.md` : 開発OSそのものの設計（メタ仕様）
   - `DEV_RULES.md` : 開発ルール（このファイル）
   - `ssot/` : プロダクトごとの仕様SSOT
   - `workflows.yml` : ワークフロー定義（どのLLMをどう組み合わせるか）
   - `workspace_llm_config.json` : 各Workspaceごとのモデル割り当て
   - `outputs/` : AIが生成するガイド・ルール類（AI_GUIDE.md, .cursorrules など）

---

## 3. 開発フローの標準手順

この開発フロー自体が、将来SaaSで提供する「標準開発フロー」となることを前提に設計する。

### 3.1 新規プロジェクト / Workspace 立ち上げ

1. テンプレRepoから新規リポジトリを作成する。
2. `DEV_OS_SPEC.md` のうち、プロダクト固有の項目（名前・VMV・対象ドメインなど）を埋める。
3. `workspace_llm_config.json` で Drafter / Reviewer / Light モデルを設定する。
4. `workflows.yml` をプロダクトに合わせて微調整する（必要なら）。

※将来のSaaSでは、この手順を「初回セットアップウィザード」としてUI化する。

### 3.2 機能追加・仕様変更フロー

1. **要求の整理（人間＋設計AI）**
   - 追加したい機能 or 解決したいペインを文章で書く。
   - 設計AIに「この要求から、どのSSOTセクションを更新すべきか」提案させる。

2. **SSOTの更新（設計AI＋複数LLMチェック）**
   - 該当する `ssot/*.yml` に対して、
     - Drafterモデルが案を作成
     - Reviewerモデルがレビュー
     - Refinerが統合
   - 人間が最終確認し、必要なら修正する。

3. **タスク生成（設計AI）**
   - 更新されたSSOTから、実装タスクを生成。
   - タスクは「Backend / Frontend / Infra / テスト」などに分解する。
   - 将来は Linear / Plane への自動連携をここに組み込む。

4. **実装プロンプト生成（設計AI）**
   - 各タスクごとに、実装AI用のプロンプトを生成する。
   - プロンプトには必ず：
     - 関連SSOT
     - 守るべき規約（型/テスト/ログなど）
     - 出力フォーマット
     を含める。

5. **実装（実装AI＋人間）**
   - 実装AIにタスクごとのプロンプトを渡し、コードや設定を生成させる。
   - 人間がレビューし、必要な修正を加える。

6. **監査（将来：監査AI）**
   - SSOTと実装コードの整合性を機械的にチェックする。
   - 差分がある場合は、どちらを正とするかを人間が判断し、SSOTまたはコードを修正する。

### 3.3 機能追加時の標準フロー

このリポジトリで、1つの機能を追加するときの標準フローを、手順だけにフォーカスして整理すると以下の通りとする。

1. **要求の整理（人間＋設計AI）**  
   - 追加したい機能や解決したいペインを文章でまとめ、背景・目的・想定ユーザーを明文化する。
2. **影響範囲の特定とSSOT更新方針の相談（設計AI）**  
   - `DEV_OS_SPEC.md` / `DEV_RULES.md` / 既存の `ssot/*.yml` を確認し、どのSSOTセクション（project, features, usecases, apis, ui_views, non_functional 等）を更新すべきかを提案する。
3. **SSOTの更新（Drafter/Reviewer/Refiner＋人間確認）**  
   - Drafterが `ssot/*.yml` の案を作成し、Reviewerが用語・整合性・SaaS共通要件の抜けをチェックし、Refinerが統合したうえで、人間が最終確認する。
4. **タスク生成（設計AI）**  
   - 更新されたSSOTから、Backend / Frontend / Infra / テスト などの実装タスクを洗い出し、粒度と優先度を整理する。
5. **実装AI向けプロンプト生成（設計AI）**  
   - 各タスクごとに、「関連するSSOT抜粋」「守るべき規約」「出力フォーマット」を含むプロンプトを生成し、必要に応じて `outputs/AI_GUIDE.md` や `.cursorrules` にも反映する。
6. **実装（実装AI＋人間レビュー）**  
   - 実装AIがプロンプトに従ってコードや設定を変更し、人間がレビューして必要な修正を行う。
7. **整合性チェック（将来：監査AI＋人間）**  
   - SSOTと実装コードの差分をチェックし、矛盾があればどちらを正とするかを人間が判断のうえ修正する。
8. **振り返りとルール更新（必要に応じて）**  
   - 開発で発見した不足や改善点を `DEV_OS_SPEC.md` / `DEV_RULES.md` / `ssot/*.yml` にフィードバックし、次回以降のフローを改善する。

---

## 4. 複数LLMチェックのルール

### 4.1 適用対象

以下のアウトプットは、原則として「複数LLMチェック」を必須とする。

- SSOT（`ssot/*.yml`）
- プロンプトテンプレート（AI用systemプロンプト、.cursorrules、AI_GUIDE.mdなど）
- 仕様レベルの文章（API設計書、ドメイン用語集 など）

### 4.2 標準フロー（Balancedモード）

1. **Drafter**
   - Sonnetなどを想定。
   - 草案を生成する。

2. **Reviewer**
   - GPT系などを想定。
   - 以下をチェック：
     - 用語の一貫性
     - 前提条件の矛盾
     - SaaS共通要件の抜け（認証/権限/テナント/課金/ログなど）
     - プロンプトとしての明確さ（ゴール/制約/出力形式/禁止事項）

3. **Refiner**
   - Drafterモデルで再統合。
   - Reviewerからの指摘を反映した「最終版」を作成する。

4. **人間の最終確認**
   - 上記の最終版を人間が読み、必要なら微修正する。
   - 大きな変更がある場合はSSOTに戻してやり直す。

---

## 5. コード実装に関するルール（MVP段階）

### 5.1 技術スタック

- ベース：Node.js + TypeScript
- CLIフレームワーク：特に指定なし（最初は軽量実装でOK）
- 設定ファイル：
  - `package.json` : スクリプト・依存管理
  - `tsconfig.json` : strictモード推奨

### 5.2 実装AIへの依頼ルール

- いきなり複数ファイルを大きく変えさせない。
- 1ターンでの指示は「1つの目的＋関連する2〜3ファイル」程度に留める。
- 実装AIには、常に以下を求める：
  - やったことの要約
  - 変更ファイル一覧
  - 重要なコード部分のみ抜粋
  - 次にやるべきことの提案

### 5.3 禁止事項

- SSOTを更新せずに、仕様に関わるコード変更を行うこと。
- 単一LLMにプロンプト/SSOTの最終版を決めさせること。
- `.cursorrules` や `AI_GUIDE.md` を、人間の確認なしに大幅変更すること。

### 5.4 CI/CD 実行ルール

#### 必須タイミング（省略不可）
以下のタイミングでは、必ず `git commit` + `git push` を行い、CI通過を確認する。

| タイミング | 理由 |
|------------|------|
| **SEC-XX（セキュリティ）タスク完了時** | テナント分離・認証関連は破綻すると致命的 |
| **機能実装完了時（2ファイル以上変更）** | 影響範囲が広いためリグレッション検知が必要 |

#### 推奨タイミング
- バグ修正・リファクタリング完了時 → 影響範囲に応じて判断

#### 報告フォーマット
実装AI は Done 報告時に以下を明記すること：

```
CI確認: ✅ Pass / ⏳ 実行中 / ❌ Fail / ⏸️ 未実行（理由）
PR: ✅ マージ済 / 🔄 レビュー中 / ⏸️ 不要（Phase 2）
```

#### CIの確認先
- GitHub Actions: `https://github.com/{org}/{repo}/actions`

### 5.5 PRルール（フェーズ別）

#### Phase 1〜2（現在）：スピード優先
| 変更種別 | PRルール | 理由 |
|---------|---------|------|
| SEC-XX（セキュリティ） | **推奨**（任意） | CI通過で十分、速度優先 |
| 機能実装（2ファイル以上） | 任意 | main直接pushでOK |
| バグ修正・軽微変更 | 不要 | main直接pushでOK |

#### Phase 3（課金開始）以降：品質担保
| 変更種別 | PRルール | 理由 |
|---------|---------|------|
| SEC-XX（セキュリティ） | **必須** | 課金前にセキュリティ担保 |
| 課金関連（Stripe等） | **必須** | 金銭に関わるためダブルチェック |
| 機能実装（2ファイル以上） | **推奨** | レビューでバグ検出 |
| バグ修正・軽微変更 | 任意 | 影響範囲に応じて判断 |

#### Phase 4（チーム拡大）以降：全員レビュー
| 変更種別 | PRルール | 理由 |
|---------|---------|------|
| すべての変更 | **必須** | チーム開発の品質担保 |

#### PRフロー（Phase 3以降）
1. 機能ブランチを作成（例: `feature/stripe-checkout`）
2. 実装完了後、PRを作成
3. CI通過を確認
4. レビュー依頼（人間 or 監査AI）
5. 承認後、mainにマージ

#### Phase移行時のチェックリスト
Phase 3開始時に以下を確認：
- [ ] GitHub Branch Protection を main に設定
- [ ] PR必須ルールを有効化
- [ ] CODEOWNERS ファイルを追加（必要に応じて）

---

## 6. このフローの「SaaS化」に向けた前提

将来、この開発OSは以下のような形でサービス化されることを前提にする。

- 各ユーザー（チーム）が「自分たちの Workspace / プロジェクト」を作成すると、
  - DEV_OS_SPEC に相当するメタ情報
  - DEV_RULES に相当する開発ルール
  - SSOTテンプレート
  を自動生成する。

- この `DEV_RULES.md` は、
  - SaaS側では「Workspaceごとの開発ルール画面」として表示・編集可能にする。
  - 実装AI・設計AIはこのルールを前提として動作する。

今後、実装が進んだ段階で、本ファイルの内容も随時アップデートし、  
「dev-os の標準開発ルール」として整備していく。



