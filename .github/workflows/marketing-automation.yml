# .github/workflows/marketing-automation.yml
# ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# æ©Ÿèƒ½:
#   - æ¯æ—¥3å›ã®è‡ªå‹•æŠ•ç¨¿ï¼ˆæœ/æ˜¼/å¤œï¼‰
#   - ABãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœ€é©åŒ–
#   - ãƒ¡ãƒˆãƒªã‚¯ã‚¹è‡ªå‹•åé›†
#   - é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
#
# å¿…è¦ãªSecrets:
#   X_API_KEY, X_API_SECRET, X_ACCESS_TOKEN, X_ACCESS_SECRET

name: Marketing Automation

on:
  schedule:
    # æœæŠ•ç¨¿ (09:30 JST = 00:30 UTC)
    - cron: '30 0 * * *'
    # æ˜¼æŠ•ç¨¿ (12:00 JST = 03:00 UTC)
    - cron: '0 3 * * *'
    # å¤œæŠ•ç¨¿ (21:00 JST = 12:00 UTC)
    - cron: '0 12 * * *'
    # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† (æ¯æ—¥ 06:00 JST = 21:00 UTCå‰æ—¥)
    - cron: '0 21 * * *'
    # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ (æ¯é€±æœˆæ›œ 09:00 JST = 00:00 UTC)
    - cron: '0 0 * * 1'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to run'
        required: true
        default: 'post_noon'
        type: choice
        options:
          - post_morning
          - post_noon
          - post_night
          - collect_metrics
          - weekly_report
          - test_dry_run

jobs:
  # æœæŠ•ç¨¿ (09:30 JST)
  post_morning:
    if: github.event.schedule == '30 0 * * *' || github.event.inputs.action == 'post_morning'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Post morning content
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: npx ts-node scripts/marketing/auto_post.ts post morning
      
      - name: Commit post history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/post_history.json
          git diff --staged --quiet || git commit -m "ğŸ“Š Update post history (morning)"
          git push

  # æ˜¼æŠ•ç¨¿ (12:00 JST)
  post_noon:
    if: github.event.schedule == '0 3 * * *' || github.event.inputs.action == 'post_noon'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Post noon content
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: npx ts-node scripts/marketing/auto_post.ts post noon
      
      - name: Commit post history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/post_history.json
          git diff --staged --quiet || git commit -m "ğŸ“Š Update post history (noon)"
          git push

  # å¤œæŠ•ç¨¿ (21:00 JST)
  post_night:
    if: github.event.schedule == '0 12 * * *' || github.event.inputs.action == 'post_night'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Post night content
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: npx ts-node scripts/marketing/auto_post.ts post night
      
      - name: Commit post history
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/post_history.json
          git diff --staged --quiet || git commit -m "ğŸ“Š Update post history (night)"
          git push

  # ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† (æ¯æ—¥ 06:00 JST)
  collect_metrics:
    if: github.event.schedule == '0 21 * * *' || github.event.inputs.action == 'collect_metrics'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Collect metrics
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: npx ts-node scripts/marketing/collect_metrics.ts collect
      
      - name: Commit metrics
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/post_history.json
          git diff --staged --quiet || git commit -m "ğŸ“ˆ Update post metrics"
          git push

  # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ (æ¯é€±æœˆæ›œ 09:00 JST)
  weekly_report:
    if: github.event.schedule == '0 0 * * 1' || github.event.inputs.action == 'weekly_report'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate weekly report
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: npx ts-node scripts/marketing/collect_metrics.ts report
      
      - name: Commit report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/metrics/
          git diff --staged --quiet || git commit -m "ğŸ“Š Weekly marketing report"
          git push

  # ãƒ†ã‚¹ãƒˆï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰
  test_dry_run:
    if: github.event.inputs.action == 'test_dry_run'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Dry run test
        run: |
          echo "ğŸ§ª Testing auto_post.ts..."
          npx ts-node scripts/marketing/auto_post.ts test noon
          echo ""
          echo "ğŸ§ª Testing collect_metrics.ts..."
          npx ts-node scripts/marketing/collect_metrics.ts report
