# ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# æ©Ÿèƒ½:
# 1. Zennè¨˜äº‹å…¬é–‹æ™‚ã®Xè‡ªå‹•å‘ŠçŸ¥
# 2. äºˆç´„æŠ•ç¨¿ã®å®šæœŸå®Ÿè¡Œ
# 3. é€±æ¬¡KPIãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

name: Marketing Automation

on:
  # Zennè¨˜äº‹ã®å¤‰æ›´ã‚’æ¤œçŸ¥
  push:
    paths:
      - 'articles/*.md'
    branches:
      - main
  
  # å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ å¯¾å¿œï¼‰
  schedule:
    # æ—¥æœ¬æ™‚é–“ 09:30 (UTC 00:30) - æœã®æŠ•ç¨¿
    - cron: '30 0 * * *'
    # æ—¥æœ¬æ™‚é–“ 12:00 (UTC 03:00) - æ˜¼ã®æŠ•ç¨¿
    - cron: '0 3 * * *'
    # æ—¥æœ¬æ™‚é–“ 12:15 (UTC 03:15) - è¨˜äº‹å‘ŠçŸ¥ç”¨
    - cron: '15 3 * * *'
    # æ—¥æœ¬æ™‚é–“ 20:30 (UTC 11:30) - å¤œã®æŠ•ç¨¿ï¼ˆæ€æƒ³å‹ï¼‰
    - cron: '30 11 * * *'
    # æ—¥æœ¬æ™‚é–“ 21:00 (UTC 12:00) - å¤œã®æŠ•ç¨¿ï¼ˆé–‹ç™ºãƒ­ã‚°ï¼‰
    - cron: '0 12 * * *'
    # æ¯æœãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆæ—¥æœ¬æ™‚é–“ 08:00 = UTC 23:00 å‰æ—¥ï¼‰
    - cron: '0 23 * * *'
    # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ—¥æ›œ 10:00 JST = åœŸæ›œ 01:00 UTCï¼‰
    - cron: '0 1 * * 0'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'process-scheduled'
        type: choice
        options:
          - process-scheduled
          - generate-kpi-report
          - announce-article
          - daily-reminder

jobs:
  # ========================================
  # Zennè¨˜äº‹å…¬é–‹æ™‚ã®Xè‡ªå‹•å‘ŠçŸ¥
  # ========================================
  announce-article:
    if: |
      github.event_name == 'push' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'announce-article')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å·®åˆ†æ¤œå‡ºç”¨
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Find published articles
        id: find-articles
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸarticlesãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'articles/*.md' || echo "")
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # published: true ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
          PUBLISHED_ARTICLES=""
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              if grep -q "published: true" "$file"; then
                PUBLISHED_ARTICLES="$PUBLISHED_ARTICLES $file"
              fi
            fi
          done
          echo "published_articles=$PUBLISHED_ARTICLES" >> $GITHUB_OUTPUT
      
      - name: Generate announcement tweets
        if: steps.find-articles.outputs.published_articles != ''
        run: |
          for file in ${{ steps.find-articles.outputs.published_articles }}; do
            # è¨˜äº‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            TITLE=$(grep "^title:" "$file" | sed 's/title: *"\(.*\)"/\1/')
            SLUG=$(basename "$file" .md)
            
            # æŠ•ç¨¿å†…å®¹ã‚’ç”Ÿæˆ
            TWEET="è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸ âœï¸

          $TITLE

          https://zenn.dev/iyasaka/articles/$SLUG?utm_campaign=x_auto_announce

          #Zenn #AIé–‹ç™º #dev-OS"
            
            echo "Announcing: $TITLE"
            echo "$TWEET"
            
            # X APIã§æŠ•ç¨¿ï¼ˆç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if [ -n "${{ secrets.X_API_KEY }}" ]; then
              # ã“ã“ã§æŠ•ç¨¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã—
              echo "Would post to X (secrets configured)"
            else
              echo "X API not configured, skipping actual post"
            fi
          done
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}

  # ========================================
  # äºˆç´„æŠ•ç¨¿ã®å®šæœŸå®Ÿè¡Œ
  # ========================================
  process-scheduled:
    if: |
      github.event_name == 'schedule' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'process-scheduled')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci
          npm install twitter-api-v2
      
      - name: Process scheduled posts
        run: |
          npx ts-node scripts/marketing/post_to_x.ts process
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
      
      - name: Commit updated schedule
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add content/x_schedule.json content/x_posted_log.json || true
          git diff --staged --quiet || git commit -m "chore: update X post schedule"
          git push || true

  # ========================================
  # é€±æ¬¡KPIãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ========================================
  generate-kpi-report:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 1 * * 0') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'generate-kpi-report')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate KPI report
        run: |
          npx ts-node scripts/marketing/generate_kpi_report.ts
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
      
      - name: Commit KPI report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/reports/kpi_*.md || true
          git diff --staged --quiet || git commit -m "chore: add weekly KPI report"
          git push || true

  # ========================================
  # æ¯æœã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆæŠœã‘æ¼ã‚Œãƒã‚§ãƒƒã‚¯ï¼‰
  # ========================================
  daily-reminder:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 23 * * *') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'daily-reminder')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check content schedule
        id: check-schedule
        run: |
          OUTPUT=$(npx ts-node scripts/marketing/check_content_schedule.ts today 2>&1)
          echo "$OUTPUT"
          
          # ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$OUTPUT" | grep -q "ğŸš¨\|âš ï¸"; then
            echo "has_alerts=true" >> $GITHUB_OUTPUT
            echo "::warning::æŠ•ç¨¿æŠœã‘æ¼ã‚Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          else
            echo "has_alerts=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Issue for alerts
        if: steps.check-schedule.outputs.has_alerts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æŠ•ç¨¿ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ (${today})`,
              body: `## æœ¬æ—¥ã®æŠ•ç¨¿äºˆå®šã‚’ã”ç¢ºèªãã ã•ã„
            
            è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã®çµæœã€æŠ•ç¨¿ã®æŠœã‘æ¼ã‚Œã¾ãŸã¯æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
            
            ### ç¢ºèªæ–¹æ³•
            \`\`\`bash
            npm run marketing:check
            \`\`\`
            
            ### ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¢ºèª
            - \`content/calendar/2026-01.yml\`
            
            ---
            ã“ã®Issueã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚`,
              labels: ['marketing', 'reminder']
            });
